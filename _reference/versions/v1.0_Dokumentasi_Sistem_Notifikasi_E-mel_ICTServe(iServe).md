# Dokumentasi Sistem Notifikasi E-mel ICTServe (iServe)

| Atribut              | Nilai                        |
| -------------------- | ---------------------------- |
| **Versi Dokumen**    | 3.0.0                        |
| **Tarikh Kemaskini** | 6 Oktober 2025               |
| **Status**           | Aktif                        |
| **Klasifikasi**      | Dokumentasi Teknikal Dalaman |
| **Penulis**          | Pasukan Pembangunan ICTServe |

## Kandungan

- [Implementasi Teknikal](#implementasi-teknikal)
- [Prestasi dan Pengoptimuman](#prestasi-dan-pengoptimuman)
- [Panduan Penyelesaian Masalah](#panduan-penyelesaian-masalah)
- [Sejarah Revisi](#sejarah-revisi)

## Implementasi Teknikal

### Pelaksanaan Perkhidmatan Notifikasi

````php
<?php



use App\Models\User;
use Illuminate\Support\Facades\Notification;
use Illuminate\Support\Facades\Log;


## Ujian dan Penyahpepijatan

### Ujian Unit
class LoanNotificationTest extends TestCase
{
    public function test_loan_approval_notification_is_sent()
    {

    Notification::fake();

    $user = User::factory()->create();
    $application = LoanApplication::factory()->create(['user_id' => $user->id]);

        $user->notify(new LoanApplicationApproved($application));

        Notification::assertSentTo(
            [$user],
            LoanApplicationApproved::class,
            function ($notification, $channels) use ($application) {
                return $notification->application->id === $application->id;
            }
        );
    }
}

### Alat Penyahpepijatan

```php
// Log semua e-mel keluar semasa pembangunan
if (app()->environment('local')) {
    $user = User::factory()->create();
    Mail::alwaysFrom('<test@ictserve.local>');
}

// Laluan pratonton e-mel (hanya pembangunan)
Route::get('/mail-preview/{notification}', function ($notification) {
    $user = User::first();
    $notificationClass = "App\\Notifications\\{$notification}";
    return (new $notificationClass($user))->toMail($user);
})->middleware(['auth', 'dev-only']);
````

## Prestasi dan Pengoptimuman

### Pengoptimuman Barisan (Queue)

```php
// Pemprosesan kelompok untuk notifikasi pukal
public function sendBulkNotifications(Collection $users, string $notificationClass): void
{
    $users->chunk(100, function ($chunk) use ($notificationClass) {
        dispatch(new ProcessBulkNotifications($chunk, $notificationClass))
            ->onQueue('bulk-notifications');
    });
}

// Had kadar (rate limiting)
RateLimiter::for('notifications', function (Request $request) {
    return Limit::perMinute(60)->by($request->user()->id);
});

// Menetapkan queue khusus untuk notifikasi
$this->queue = 'notifications';
```

### Strategi Caching

```php
// Cache templat e-mel yang kerap digunakan
Cache::remember("email*template*{$templateName}", 3600, function () use ($templateName) {
    return view("emails.{$templateName}")->render();
});

// Cache keutamaan notifikasi pengguna
Cache::remember("user*notification_settings*{$userId}", 86400, function () use ($userId) {
    return User::find($userId)->notificationSettings;
});
```

## Panduan Penyelesaian Masalah

### Isu Lazim

| Isu                  | Simptom                                       | Penyelesaian                                           |
| -------------------- | --------------------------------------------- | ------------------------------------------------------ |
| E-mel tidak dihantar | Tiada e-mel diterima, tiada ralat             | Semak pekerja barisan, sahkan tetapan SMTP             |
| Notifikasi lewat     | Kelewatan lama antara pencetus dan penerimaan | Tambah pekerja barisan, optimumkan pemprosesan barisan |
| E-mel berganda       | Salinan e-mel sama berulang                   | Semak logik cubaan semula, pastikan idempoten          |
| Ralat templat        | Susun atur rosak, pembolehubah hilang         | Sahkan pembolehubah templat, uji paparan               |
| E-mel melantun       | Kadar lantunan tinggi                         | Sahkan alamat e-mel, laksanakan pengesahan             |

### Senarai Semak Pemantauan

```yaml
Pemantauan Harian:
    - [ ] Semak kadar penghantaran e-mel
    - [ ] Semak barisan kerja gagal
    - [ ] Pantau kadar lantunan
    - [ ] Semak masa pemprosesan barisan

Semakan Mingguan:
    - [ ] Analisis statistik penghantaran
    - [ ] Semak log ralat
    - [ ] Kemas kini senarai lantunan
    - [ ] Pengoptimuman prestasi

Audit Bulanan:
    - [ ] Keberkesanan templat
    - [ ] Metik penglibatan pengguna
    - [ ] Semakan prestasi sistem
    - [ ] Audit keselamatan
```

### Prosedur Kecemasan

```bash
# Hentikan semua pemprosesan notifikasi
php artisan queue:pause

echo "Kosongkan kerja gagal"
php artisan queue:flush

echo "Mulakan semula pekerja barisan"
php artisan queue:restart

echo "Proses kerja gagal tertentu"
php artisan queue:retry {job-id}

echo "Pantau status barisan masa nyata"
php artisan queue:monitor notifications,emails --max=100
```

## Sejarah Revisi

| Versi | Tarikh    | Penulis          | Perubahan     |
| ----- | --------- | ---------------- | ------------- |
| 1.0   | Sept 2025 | Pasukan ICTServe | Keluaran awal |
